name: Ultimate Website Crawler ï¼ˆMainï¼‰ 

on:
  repository_dispatch:
  workflow_dispatch:
  #schedule:
    # Runs at 00:05 UTC every Saturday
   # - cron: '5 0 * * 6'

jobs:
  crawl-and-notify:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Initialize environment
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        export DIR_NAME="webpages-$(TZ='Asia/Shanghai' date +'%Y%m%d')"
        echo "DIR_NAME=$DIR_NAME" >> $GITHUB_ENV
        mkdir -p $DIR_NAME
        echo "ğŸ•’ åˆå§‹åŒ–ç›®å½•å®Œæˆï¼š$DIR_NAME"

    - name: Advanced website crawling
      run: |
        # ç»ˆæé˜²å¾¡å¼æŠ“å–å‚æ•°
        wget --mirror \
             --convert-links \
             --adjust-extension \
             --page-requisites \
             --no-parent \
             --no-check-certificate \
             --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
             --retry-on-http-error=403,429,500-599 \
             --tries=2 \
             --wait=3 \
             --random-wait \
             --span-hosts \
             --domains saoing.com,www.saoing.com \
             --restrict-file-names=windows \
             --reject-regex '\s|%20|^http://[^/]*\s' \
             --exclude-directories='/EIRP,/tmp' \
             --no-directories \
             --level=5 \
             --quota=500m \
             --header="Accept: text/html,application/xhtml+xml" \
             -e robots=off \
             --debug \
             -P $DIR_NAME \
             http://www.saoing.com/ 2>wget-errors.log || true

        # å¼ºåˆ¶ç”Ÿæˆæœ‰æ•ˆç›®å½•ç»“æ„
        find $DIR_NAME -type d -exec touch {}/.keep \;

    - name: Content verification
      run: |
        echo "ğŸ” å†…å®¹éªŒè¯æŠ¥å‘Šï¼š"
        echo "æ ¸å¿ƒæ–‡ä»¶æ£€æµ‹ï¼š"
        ls $DIR_NAME/www.saoing.com/index.* 2>/dev/null || echo "æœªæ‰¾åˆ°indexæ–‡ä»¶"
        
        echo "æ–‡ä»¶ç»Ÿè®¡ï¼š"
        find $DIR_NAME -type f | wc -l | xargs echo "æ€»æ–‡ä»¶æ•°ï¼š"
        
        echo "é”™è¯¯æ—¥å¿—æ‘˜è¦ï¼š"
        grep -iE 'failed|error|warn' wget-errors.log | head -n 5

        if [ -n "$(find $DIR_NAME -name '*.htm*')" ]; then
          echo "CONTENT_VALID=1" >> $GITHUB_ENV
        else
          echo "CONTENT_VALID=0" >> $GITHUB_ENV
        fi

    - name: Git operations
      run: |
        git config --global user.name "GitHub Archiver"
        git config --global user.email "archive@github.com"
        git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

        git add $DIR_NAME
        if ! git commit -m "Archived: $DIR_NAME"; then
          echo "ğŸ”„ æ— æ–°å†…å®¹å˜æ›´"
          exit 0  # å…è®¸æ— å˜æ›´é€€å‡º
        fi
        git push

    - name: Smart notification
      if: always()
      env:
        TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # é«˜çº§é€šçŸ¥é€»è¾‘
        ERROR_MSG=$(tail -n 10 wget-errors.log | sed 's/%/%25/g')
        FILE_TREE=$(tree -L 2 $DIR_NAME | head -n 5 | sed 's/%/%25/g')
        
        if [ "$CONTENT_VALID" -eq 1 ]; then
          EMOJI="ğŸ‰"
          STATUS="æˆåŠŸæŠ“å–"
          BUTTON="--inline-keyboard '[[{text: \"æµè§ˆç›®å½•\", url: \"https://github.com/$GITHUB_REPOSITORY/tree/main/$DIR_NAME\"}]]'"
        else
          EMOJI="âš ï¸"
          STATUS="éƒ¨åˆ†å¤±è´¥"
          BUTTON=""
        fi

        curl -s -X POST \
          "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
          -d chat_id="${TG_CHAT}" \
          -d parse_mode="HTML" \
          -d text="<b>${EMOJI} æŠ“å–æŠ¥å‘Š</b>
          â–«ï¸ çŠ¶æ€: ${STATUS}
          â–«ï¸ æ—¥æœŸ: $(date +'%m-%d %H:%M')
          â–«ï¸ ç›®å½•: <code>${DIR_NAME}</code>
          â–«ï¸ æ–‡ä»¶é¢„è§ˆ:
          <pre>${FILE_TREE}</pre>
          â–«ï¸ æœ€æ–°æ—¥å¿—:
          <pre>${ERROR_MSG}</pre>" \
          -d reply_markup="${BUTTON}"
